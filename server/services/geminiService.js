const { GoogleGenerativeAI } = require('@google/generative-ai');
const config = require('../config/config');

class GeminiService {
  constructor() {
    if (!config.gemini.apiKey) {
      throw new Error('GEMINI_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è');
    }
    this.genAI = new GoogleGenerativeAI(config.gemini.apiKey);
    this.model = this.genAI.getGenerativeModel({ model: 'gemini-2.0-flash' });
  }

  // –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
  createTourismContext(userPreferences = {}, availableTours = []) {
    return `
–¢—ã - –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –¥–ª—è –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ "Nomad Route". 
–¢–≤–æ—è —Ü–µ–ª—å - –ø–æ–º–æ—á—å –ø—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞–º –æ—Ç–∫—Ä—ã—Ç—å –∫—Ä–∞—Å–æ—Ç—É –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞ –∏ –Ω–∞–π—Ç–∏ –∏–¥–µ–∞–ª—å–Ω—ã–µ —Ç—É—Ä—ã.

–¢–í–û–Ø –†–û–õ–¨:
- –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ç—É—Ä–∏–∑–º—É –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ
- –ó–Ω–∞–µ—à—å –≤—Å–µ –æ –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—è—Ö, –∫—É–ª—å—Ç—É—Ä–µ, –∏—Å—Ç–æ—Ä–∏–∏ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞
- –ü–æ–º–æ–≥–∞–µ—à—å –≤—ã–±—Ä–∞—Ç—å —Ç—É—Ä—ã, –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç—ã
- –î–∞–µ—à—å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã –¥–ª—è –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–π

–î–û–°–¢–£–ü–ù–´–ï –¢–£–†–´:
${availableTours.map(tour => `
- ${tour.title} (${tour.price}‚ÇΩ)
  –†–µ–≥–∏–æ–Ω: ${tour.region}
  –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${tour.duration} –¥–Ω–µ–π
  –û–ø–∏—Å–∞–Ω–∏–µ: ${tour.description}
  –†–µ–π—Ç–∏–Ω–≥: ${tour.rating || '–ù–µ—Ç –æ—Ü–µ–Ω–æ–∫'}
`).join('\n')}

–ü–†–ï–î–ü–û–ß–¢–ï–ù–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:
${Object.entries(userPreferences).map(([key, value]) => `${key}: ${value}`).join('\n')}

–ü–†–ê–í–ò–õ–ê –û–ë–©–ï–ù–ò–Ø:
- –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
- –ë—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º
- –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è –±–æ–ª—å—à–µ–π –≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –î–∞–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Ü–µ–Ω
- –ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å —Ç–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é - —á–µ—Å—Ç–Ω–æ —Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º
- –ü—Ä–µ–¥–ª–∞–≥–∞–π –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω–æ–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ
- –ò—Å–ø–æ–ª—å–∑—É–π —Ñ–∞–∫—Ç—ã –æ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ –¥–ª—è –æ–±–æ–≥–∞—â–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤
`;
  }

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
  async generateResponse(message, context = '', chatHistory = []) {
    try {
      // –°–æ–∑–¥–∞–µ–º –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
      const fullContext = `
${context}

–ò–°–¢–û–†–ò–Ø –†–ê–ó–ì–û–í–û–†–ê:
${chatHistory.map(msg => `${msg.role}: ${msg.content}`).join('\n')}

–ù–û–í–û–ï –°–û–û–ë–©–ï–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø: ${message}

–û—Ç–≤–µ—á–∞–π –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, —É—á–∏—Ç—ã–≤–∞—è –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–∞. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ —Ç—É—Ä–∞—Ö, 
–ø—Ä–µ–¥–ª–∞–≥–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç—É—Ä–æ–≤.
`;

      const result = await this.model.generateContent(fullContext);
      const response = await result.response;
      return response.text();
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞ Gemini:', error);
      throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞');
    }
  }

  // –ê–Ω–∞–ª–∏–∑ –∏–Ω—Ç–µ–Ω—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  async analyzeIntent(message) {
    try {
      const prompt = `
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ–ø—Ä–µ–¥–µ–ª–∏ –µ–≥–æ –Ω–∞–º–µ—Ä–µ–Ω–∏–µ:

–°–æ–æ–±—â–µ–Ω–∏–µ: "${message}"

–í–æ–∑–º–æ–∂–Ω—ã–µ –∏–Ω—Ç–µ–Ω—Ç—ã:
- tour_search (–ø–æ–∏—Å–∫ —Ç—É—Ä–æ–≤)
- tour_info (–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º —Ç—É—Ä–µ)
- destination_info (–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏)
- price_inquiry (–≤–æ–ø—Ä–æ—Å—ã –æ —Ü–µ–Ω–∞—Ö)
- booking_help (–ø–æ–º–æ—â—å —Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
- general_info (–æ–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ)
- planning_help (–ø–æ–º–æ—â—å –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø–æ–µ–∑–¥–∫–∏)
- other (–¥—Ä—É–≥–æ–µ)

–í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–Ω—Ç–∞ –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º.
`;

      const result = await this.model.generateContent(prompt);
      const response = await result.response;
      return response.text().trim().toLowerCase();
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –∏–Ω—Ç–µ–Ω—Ç–∞:', error);
      return 'other';
    }
  }

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –±—ã—Å—Ç—Ä—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
  async generateQuickQuestions(userContext = {}) {
    try {
      const prompt = `
–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π 4 –∫—Ä–∞—Ç–∫–∏—Ö –≤–æ–ø—Ä–æ—Å–∞-–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–ª—è —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ —á–∞—Ç–∞-–±–æ—Ç–∞ –ø–æ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—É.
–í–æ–ø—Ä–æ—Å—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏, –ø–æ–ª–µ–∑–Ω—ã–º–∏ –∏ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–º–∏.

–ü—Ä–∏–º–µ—Ä—ã –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${JSON.stringify(userContext)}

–í–µ—Ä–Ω–∏ –æ—Ç–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON –º–∞—Å—Å–∏–≤–∞ —Å—Ç—Ä–æ–∫:
["–≤–æ–ø—Ä–æ—Å 1", "–≤–æ–ø—Ä–æ—Å 2", "–≤–æ–ø—Ä–æ—Å 3", "–≤–æ–ø—Ä–æ—Å 4"]

–í–æ–ø—Ä–æ—Å—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∫–æ—Ä–æ—Ç–∫–∏–º–∏ (–Ω–µ –±–æ–ª–µ–µ 50 —Å–∏–º–≤–æ–ª–æ–≤) –∏ –ø–æ–∫—Ä—ã–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã:
- –ü–æ–∏—Å–∫ —Ç—É—Ä–æ–≤
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥–æ—Ä–æ–¥–∞—Ö
- –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã
- –ö—É–ª—å—Ç—É—Ä–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
`;

      const result = await this.model.generateContent(prompt);
      const response = await result.response;
      const text = response.text().trim();
      
      try {
        return JSON.parse(text);
      } catch {
        // –ï—Å–ª–∏ JSON –Ω–µ —Ä–∞—Å–ø–∞—Ä—Å–∏–ª—Å—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã
        return [
          "üèîÔ∏è –õ—É—á—à–∏–µ –ø—Ä–∏—Ä–æ–¥–Ω—ã–µ —Ç—É—Ä—ã",
          "üèõÔ∏è –ö—É–ª—å—Ç—É—Ä–Ω—ã–µ –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏",
          "üí∞ –ë—é–¥–∂–µ—Ç–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ç—É—Ä–æ–≤",
          "üó∫Ô∏è –ü–æ–º–æ—â—å –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞"
        ];
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –±—ã—Å—Ç—Ä—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤:', error);
      return [
        "üèîÔ∏è –õ—É—á—à–∏–µ –ø—Ä–∏—Ä–æ–¥–Ω—ã–µ —Ç—É—Ä—ã",
        "üèõÔ∏è –ö—É–ª—å—Ç—É—Ä–Ω—ã–µ –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏", 
        "üí∞ –ë—é–¥–∂–µ—Ç–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ç—É—Ä–æ–≤",
        "üó∫Ô∏è –ü–æ–º–æ—â—å –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞"
      ];
    }
  }

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
  async generatePersonalizedRecommendations(userProfile, availableTours, preferences = {}) {
    try {
      const prompt = `
–ù–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –µ–≥–æ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π, –ø—Ä–µ–¥–ª–æ–∂–∏ 3 –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Ç—É—Ä–∞ –∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö.

–ü–†–û–§–ò–õ–¨ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:
${JSON.stringify(userProfile, null, 2)}

–ü–†–ï–î–ü–û–ß–¢–ï–ù–ò–Ø:
${JSON.stringify(preferences, null, 2)}

–î–û–°–¢–£–ü–ù–´–ï –¢–£–†–´:
${JSON.stringify(availableTours, null, 2)}

–í–µ—Ä–Ω–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
{
  "recommendations": [
    {
      "tourId": "id —Ç—É—Ä–∞",
      "reason": "–∫—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø–æ—á–µ–º—É —ç—Ç–æ—Ç —Ç—É—Ä –ø–æ–¥—Ö–æ–¥–∏—Ç",
      "matchScore": —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 10
    }
  ]
}
`;

      const result = await this.model.generateContent(prompt);
      const response = await result.response;
      const text = response.text().trim();
      
      try {
        return JSON.parse(text);
      } catch {
        return { recommendations: [] };
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π:', error);
      return { recommendations: [] };
    }
  }
}

module.exports = new GeminiService(); 